В мире современной разработки программного обеспечения процесс интеграции и развертывания нового кода стал намного более сложным и требовательным к автоматизации. Для упрощения этого процесса и обеспечения надежности развертывания, многие команды разработчиков обращаются к Kubernetes. В этой статье мы рассмотрим, почему Kubernetes стал популярным инструментом для развертывания веток и Pull Request'ов разработчиков.

### Преимущества Kubernetes

#### 1. Изоляция с помощью Namespaces

Kubernetes предоставляет мощный механизм изоляции, который позволяет каждой ветке кода и Pull Request'у работать в собственном изолированном пространстве. Это достигается с помощью концепции Namespaces. Namespaces позволяют разграничить ресурсы, такие как CPU, память, сеть и хранилище, между различными ветками кода и Pull Request'ами. Это обеспечивает высокую степень безопасности и изоляции, предотвращая возможные конфликты и помогая избежать взаимных влияний.

#### 2. Горизонтальное масштабирование

Одним из ключевых преимуществ Kubernetes является его способность горизонтального масштабирования. Это означает, что вы можете легко управлять различными ветками кода и Pull Request'ами, увеличивая или уменьшая количество ресурсов, выделенных каждому из них, в зависимости от их нагрузки. Это делает Kubernetes идеальным инструментом для работы с разнообразными проектами и командами разработчиков, где требуется гибкость в управлении ресурсами.

#### 3. Управление конфигурациями с помощью Helm / Werf

Для управления конфигурациями при развертывании веток кода и Pull Request'ов можно использовать Helm - пакетный менеджер для Kubernetes. Helm позволяет создавать чарты, которые определяют, какие ресурсы должны быть созданы и какие параметры конфигурации использовать. Это упрощает процесс развертывания и позволяет быстро вносить изменения в конфигурацию при необходимости.
Однако работать напрямую с Helm не очень удобно. Для упрощения развертывания мы создали набор шаблонов для Werf и настроили Github Actions для запуска данных процессов.

Все наши шаблоны размещены в публичном репозитории https://github.com/iconicompany/werfactions, но если вы хотите их использовать, вам лучше сделать локальный fork.

Пример использования в github actions:

#### Выкладка в продакшен из тэга:
```
name: Production Deployment
on:
  push:
    tags: ['*']

jobs:

  call-converge:
    uses: iconicompany/werfactions/.github/workflows/deployment.yml@main
    secrets: inherit
    with:
      registry: registry.gitlab.com
      context: production
      environment: production
      domain: iconicompany.ru
``` 

#### Пример выкладки Pull Request

Выкладка PR происходит в момент добавления метки `review` в Pull Request, при снятии метки или закрытия PR ресурсы освобождаются 

```
name: Pull Request Deployment
on: pull_request

jobs:

  call-converge:
    uses: iconicompany/werfactions/.github/workflows/deployment.yml@main
    secrets: inherit
    with:
      registry: registry.gitlab.com
      context: testing
      environment: ${{ github.head_ref || github.ref_name }}
      domain: ${{ github.head_ref || github.ref_name }}.${{ github.repository_owner }}.icncd.ru

```

### Запуск авто-тестов в библиотеке Playwright

После развертывания веток кода и Pull Request'ов на кластере Kubernetes, важно удостовериться в их надежности и стабильности. Для этого часто используют автоматизированные тесты, и в этом контексте библиотека Playwright может быть идеальным выбором.

#### 1. Установка Playwright

Для начала необходимо установить библиотеку Playwright в Kubernetes-кластере. Это можно сделать с помощью Docker-образов, содержащих необходимые зависимости. Образы могут быть созданы с использованием инструментов управления конфигурацией, таких как Helm, для облегчения процесса установки и обновления.

#### 2. Настройка и запуск тестов

Playwright предоставляет обширный набор инструментов для автоматизации браузерных тестов. Тесты могут быть настроены для выполнения на каждой ветке кода или Pull Request'е. Например, при создании Pull Request'а, автоматизированные тесты могут быть запущены для проверки, не вызывает ли новый код проблем на уровне пользовательского интерфейса или функциональности.

#### 3. Возвращение результатов

После выполнения авто-тестов, результаты могут быть возвращены в систему управления разработкой, такую как GitHub или GitLab. Это позволяет разработчикам получать быструю обратную связь о качестве своего кода и делать необходимые корректировки до момента слияния изменений.

Использование Kubernetes для развертывания веток кода и Pull Request'ов, а также интеграция библиотеки Playwright для авто-тестирования, позволяют значительно упростить и ускорить процесс разработки и развертывания, обеспечивая при этом высокую степень изоляции и безопасности. Эти инструменты способствуют автоматизации и улучшению качества кода, что важно для современных команд разработчиков, стремящихся к более эффективному и надежному процессу разработки ПО.

